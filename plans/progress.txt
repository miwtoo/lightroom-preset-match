# Progress

## 2026-01-26: Test: E2E export download flow (.xmp)

### Task completed
- Created `e2e/export-download.spec.ts` with two scenarios
- Scenario 1: valid preset name triggers .xmp download and shows iPad import guidance
- Scenario 2: invalid preset name blocks download and shows validation error
- In-test image upload via base64 buffer (no committed fixture)
- All E2E tests pass (3 total: smoke + 2 export-download)
- Full gate passes (test + typecheck + build + e2e)

## 2026-01-26: Export to XMP with iPad import workflow

### Task completed
- Replaced `.lrtemplate`/custom XML export with deterministic `.xmp` export (Camera Raw Settings, Basic + HSL only)
- Updated `lib/preset-export.ts` with XMP serialization, XML escaping, safe filename handling, and stable UUID generation
- Updated `lib/preset-generator.ts` to support typed HSL channels and extend `scaleAdjustments` to scale HSL maps
- Updated `components/PresetExport.tsx` to use library export functions, validate names (char set), and show `.xmp` import guidance + troubleshooting
- Updated `components/PresetPreview.tsx` and `app/page.tsx` to import `PresetAdjustments` from lib (single source of truth)
- Updated `README.md` with iPad import workflow, supported formats/devices, privacy statement, and troubleshooting sections
- Updated unit tests in `lib/preset-export.test.ts` for XMP structure, XML escaping, determinism, formatting, and UUID stability
- Created `plans/progress.txt` for tracking progress

### Key decisions made
- Export artifact: single `.xmp` (Camera Raw Settings preset), Basic (PV2012) + HSL only
- No iPadOS/Lightroom version claims; wording: "requires Lightroom iPad that supports importing XMP presets"
- Preset name validation: A-Z a-z 0-9 space - _ . only
- Determinism: stable tag ordering, stable numeric formatting (+ for positive values), content-derived UUID

### Files changed
- `lib/preset-export.ts`: Complete rewrite for XMP export
- `lib/preset-generator.ts`: Added typed HSL channels and `scaleMap` helper
- `components/PresetExport.tsx`: Updated to use library functions and `.xmp` workflow
- `components/PresetPreview.tsx`: Import type from lib
- `app/page.tsx`: Import type from lib
- `components/ImageUpload.tsx`: Export ImageData type
- `README.md`: Updated with iPad workflow and troubleshooting
- `lib/preset-export.test.ts`: Rewrote tests for XMP functions
- `plans/progress.txt`: Created

### Unresolved questions
- None (export format and workflow are now defined)

### Notes for next iteration
- Manual verification on iPad Safari for download + Lightroom import
- Consider adding `.zip` wrapper for batch import if requested later
- ImageUpload error handling improvements (currently console.error, could add to UI)

## 2026-01-26: UI: Editor-style shell (display-only panels)

### Task completed
- Implemented always-dark editor shell with 3-panel responsive layout
- Added live histogram view, read-only tone/curve sections, and split preview styling
- Added reference file card with basic file info and export panel styling
- Added Playwright coverage for editor shell layout and file info

### Key decisions made
- Always-dark theme to match the provided mock
- Split preview fixed at 50% for v1 (no draggable divider yet)
- Histogram reflects before/after depending on generation state

### Files changed
- `app/globals.css`
- `app/layout.tsx`
- `app/page.tsx`
- `components/Histogram.tsx`
- `components/ImageUpload.tsx`
- `components/PresetPreview.tsx`
- `components/PresetExport.tsx`
- `lib/histogram.ts`
- `e2e/editor-shell.spec.ts`
- `e2e/export-download.spec.ts`

### Notes for next iteration
- Add draggable split divider and connect intensity to export output

## 2026-01-26: Preview intensity applies to export output

### Task completed
- Scaled preset export output by intensity before XMP generation
- Added unit coverage for intensity-scaled export
- Added Playwright coverage to verify intensity affects downloaded XMP

### Key decisions made
- Export now uses `scaleAdjustments` to keep preview and exported preset consistent
- Demo adjustments set to non-zero values to enable verification in UI tests

### Files changed
- `lib/preset-export.ts`
- `components/PresetExport.tsx`
- `lib/preset-export.test.ts`
- `app/page.tsx`
- `e2e/export-download.spec.ts`

## 2026-01-30: Feature: Draggable preview divider and Reset Intensity

### Task completed
- Implemented draggable split divider in `PresetPreview` with mouse and touch support
- Added state for `splitPosition` and cursor styling to the divider
- Added an explicit "Reset" action for Intensity in the sidebar
- Full gate passes (unit + typecheck + build + E2E)

### Key decisions made
- Used a floating handle styling for the divider to make it more discoverable
- "Reset" button for intensity is conditionally shown only when adjustments exist and intensity is non-default
- Used `window` event listeners for dragging to ensure a smooth experience even when the cursor leaves the preview frame

### Files changed
- `components/PresetPreview.tsx`
- `app/page.tsx`
- `app/globals.css`
- `plans/progress.txt`

## 2026-01-30: Feature: Improved upload pipeline with early downscaling

### Task completed
- Implemented early downscaling in `ImageUpload` (MAX 1200px) to prevent memory pressure on iPad Safari
- Switched to `URL.createObjectURL` for safer and faster image loading
- Added explicit file type validation and descriptive error messages
- Improved accessibility with `aria-label` and `role="alert"` for error states
- Added E2E test for invalid file types
- Full gate passes (unit + typecheck + build + E2E)

### Key decisions made
- Set `MAX_WORKING_DIMENSION` to 1200px as a safe balance between analysis detail and memory usage
- Revoke object URLs immediately after processing to prevent memory leaks

### Files changed
- `components/ImageUpload.tsx`
- `e2e/editor-shell.spec.ts`
- `plans/progress.txt`

### Notes for next iteration
- Start on core generation pipeline (Issue #3) - mapping image stats to real adjustments
