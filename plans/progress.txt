# Progress

## 2026-01-26: Test: E2E export download flow (.xmp)

### Task completed
- Created `e2e/export-download.spec.ts` with two scenarios
- Scenario 1: valid preset name triggers .xmp download and shows iPad import guidance
- Scenario 2: invalid preset name blocks download and shows validation error
- In-test image upload via base64 buffer (no committed fixture)
- All E2E tests pass (3 total: smoke + 2 export-download)
- Full gate passes (test + typecheck + build + e2e)

## 2026-01-26: Export to XMP with iPad import workflow

### Task completed
- Replaced `.lrtemplate`/custom XML export with deterministic `.xmp` export (Camera Raw Settings, Basic + HSL only)
- Updated `lib/preset-export.ts` with XMP serialization, XML escaping, safe filename handling, and stable UUID generation
- Updated `lib/preset-generator.ts` to support typed HSL channels and extend `scaleAdjustments` to scale HSL maps
- Updated `components/PresetExport.tsx` to use library export functions, validate names (char set), and show `.xmp` import guidance + troubleshooting
- Updated `components/PresetPreview.tsx` and `app/page.tsx` to import `PresetAdjustments` from lib (single source of truth)
- Updated `README.md` with iPad import workflow, supported formats/devices, privacy statement, and troubleshooting sections
- Updated unit tests in `lib/preset-export.test.ts` for XMP structure, XML escaping, determinism, formatting, and UUID stability
- Created `plans/progress.txt` for tracking progress

### Key decisions made
- Export artifact: single `.xmp` (Camera Raw Settings preset), Basic (PV2012) + HSL only
- No iPadOS/Lightroom version claims; wording: "requires Lightroom iPad that supports importing XMP presets"
- Preset name validation: A-Z a-z 0-9 space - _ . only
- Determinism: stable tag ordering, stable numeric formatting (+ for positive values), content-derived UUID

### Files changed
- `lib/preset-export.ts`: Complete rewrite for XMP export
- `lib/preset-generator.ts`: Added typed HSL channels and `scaleMap` helper
- `components/PresetExport.tsx`: Updated to use library functions and `.xmp` workflow
- `components/PresetPreview.tsx`: Import type from lib
- `app/page.tsx`: Import type from lib
- `components/ImageUpload.tsx`: Export ImageData type
- `README.md`: Updated with iPad workflow and troubleshooting
- `lib/preset-export.test.ts`: Rewrote tests for XMP functions
- `plans/progress.txt`: Created

### Unresolved questions
- None (export format and workflow are now defined)

### Notes for next iteration
- Manual verification on iPad Safari for download + Lightroom import
- Consider adding `.zip` wrapper for batch import if requested later
- ImageUpload error handling improvements (currently console.error, could add to UI)

## 2026-01-26: UI: Editor-style shell (display-only panels)

### Task completed
- Implemented always-dark editor shell with 3-panel responsive layout
- Added live histogram view, read-only tone/curve sections, and split preview styling
- Added reference file card with basic file info and export panel styling
- Added Playwright coverage for editor shell layout and file info

### Key decisions made
- Always-dark theme to match the provided mock
- Split preview fixed at 50% for v1 (no draggable divider yet)
- Histogram reflects before/after depending on generation state

### Files changed
- `app/globals.css`
- `app/layout.tsx`
- `app/page.tsx`
- `components/Histogram.tsx`
- `components/ImageUpload.tsx`
- `components/PresetPreview.tsx`
- `components/PresetExport.tsx`
- `lib/histogram.ts`
- `e2e/editor-shell.spec.ts`
- `e2e/export-download.spec.ts`

### Notes for next iteration
- Add draggable split divider and connect intensity to export output

## 2026-01-26: Preview intensity applies to export output

### Task completed
- Scaled preset export output by intensity before XMP generation
- Added unit coverage for intensity-scaled export
- Added Playwright coverage to verify intensity affects downloaded XMP

### Key decisions made
- Export now uses `scaleAdjustments` to keep preview and exported preset consistent
- Demo adjustments set to non-zero values to enable verification in UI tests

### Files changed
- `lib/preset-export.ts`
- `components/PresetExport.tsx`
- `lib/preset-export.test.ts`
- `app/page.tsx`
- `e2e/export-download.spec.ts`

## 2026-01-30: Feature: Draggable preview divider and Reset Intensity

### Task completed
- Implemented draggable split divider in `PresetPreview` with mouse and touch support
- Added state for `splitPosition` and cursor styling to the divider
- Added an explicit "Reset" action for Intensity in the sidebar
- Full gate passes (unit + typecheck + build + E2E)

### Key decisions made
- Used a floating handle styling for the divider to make it more discoverable
- "Reset" button for intensity is conditionally shown only when adjustments exist and intensity is non-default
- Used `window` event listeners for dragging to ensure a smooth experience even when the cursor leaves the preview frame

### Files changed
- `components/PresetPreview.tsx`
- `app/page.tsx`
- `app/globals.css`
- `plans/progress.txt`

## 2026-01-30: Feature: Improved upload pipeline with early downscaling

### Task completed
- Implemented early downscaling in `ImageUpload` (MAX 1200px) to prevent memory pressure on iPad Safari
- Switched to `URL.createObjectURL` for safer and faster image loading
- Added explicit file type validation and descriptive error messages
- Improved accessibility with `aria-label` and `role="alert"` for error states
- Added E2E test for invalid file types
- Full gate passes (unit + typecheck + build + E2E)

### Key decisions made
- Set `MAX_WORKING_DIMENSION` to 1200px as a safe balance between analysis detail and memory usage
- Revoke object URLs immediately after processing to prevent memory leaks

### Files changed
- `components/ImageUpload.tsx`
- `e2e/editor-shell.spec.ts`
- `plans/progress.txt`

## 2026-01-30: Feature: Core generation pipeline (stats to adjustments)

### Task completed
- Implemented deterministic image analysis pipeline (luminance stats + coarse color stats)
- Added mapping from image stats to Basic (Exposure, Contrast, Highlights, Shadows) and HSL (Saturation) adjustments
- Refactored architecture to compute stats once during upload, improving performance and reliability
- Added unit tests for analysis and preset generation logic
- Added "Processing image..." loading state during upload and analysis
- Updated E2E tests to wait for analysis completion and handle dynamic generated values
- Full gate passes (unit + typecheck + build + E2E)

### Key decisions made
- Use Rec. 709 luminance weights for more accurate tonal analysis
- Mapping targets middle gray (128) for exposure and uses dynamic range (p5-p95) for contrast
- Stats calculation happens in `ImageUpload` component immediately after downscaling to ensure data is ready for the "Generate" action

### Files changed
- `lib/preset-generator.ts`
- `lib/preset-generator.test.ts`
- `components/ImageUpload.tsx`
- `components/PresetPreview.tsx`
- `app/page.tsx`
- `e2e/export-download.spec.ts`
- `plans/progress.txt`

## 2026-01-30: Feature: Privacy info and Clear Session

### Task completed
- Added prominent "Clear Session" button in the header
- Added explicit in-UI privacy copy in the sidebar and header
- Updated `handleClear` to reset all analysis and histogram states
- Added E2E test for clear session functionality
- Fixed race conditions and loop issues in `PresetPreview` by using `useCallback` and refactoring stats to upload pipeline
- Updated smoke tests to reflect new UI copy
- Full gate passes (unit + typecheck + build + E2E)

### Key decisions made
- Positioned "Clear Session" in the header for easy access while working
- Clarified privacy wording to emphasize that processing is local and private

### Files changed
- `app/page.tsx`
- `e2e/editor-shell.spec.ts`
- `e2e/smoke.spec.ts`
- `plans/progress.txt`

## 2026-01-30: Feature: Tone zone (Z0â€“ZX) calculation and display

### Task completed
- Implemented tone zone distribution calculation (11 zones) in `analyzeImage`
- Added visual representation of tone distribution in the `TONE_STRIP` component
- Zones update dynamically when a reference image is processed
- Added unit test for `analyzeImage` to verify correct luminance and zone calculation
- Refined basic tone mapping with safer bounds and better dynamic range usage
- Full gate passes (unit + typecheck + build + E2E)

### Key decisions made
- Use 11 zones (Z0 to ZX) to match the Lightroom UI mock
- Visualized zone weight as a translucent bar behind/above the zone color to avoid cluttering the UI
- Maintained determinism in zone calculation by using the same downsampled analysis path

### Files changed
- `lib/preset-generator.ts`
- `lib/preset-generator.test.ts`
- `app/page.tsx`
- `plans/progress.txt`

## 2026-01-31: Feature: HSL Color Mixer panel (Issue #12)

### Task completed
- Created `components/ColorMixer.tsx` with display-only HSL panel for 8 color channels
- Added color indicators (Red, Orange, Yellow, Green, Aqua, Blue, Purple, Magenta)
- Integrated ColorMixer into left sidebar in `app/page.tsx`
- Added unit tests for ColorMixer component
- Full gate passes (14 tests + typecheck + build)

### Key decisions made
- Display-only (vNext scope) - sliders are disabled, matching the editor shell pattern
- Shows only channels with values (not all 8 empty channels)
- Hue/Sat/Lum grid layout (3 columns per channel)
- Color-coded channel indicators for quick visual recognition

### Files changed
- `components/ColorMixer.tsx` (created)
- `components/ColorMixer.test.tsx` (created)
- `app/page.tsx` (added import and component usage)
- `plans/progress.txt` (updated)

## 2026-01-31: Feature: Camera Calibration controls (Issue #13)

### Task completed
- Defined `CalibrationAdjustments` model in `lib/preset-generator.ts`
- Added Calibration scaling logic to `scaleAdjustments`
- Created `components/Calibration.tsx` display-only panel for Shadow Tint and RGB Primaries
- Updated `lib/preset-export.ts` to include Calibration tags in XMP output
- Integrated Calibration panel into sidebar in `app/page.tsx`
- Updated unit tests in `lib/preset-generator.test.ts` and `lib/preset-export.test.ts`
- Updated `components/PresetPreview.tsx` to include `calibration` in `EMPTY_ADJUSTMENTS`
- Full gate passes (unit + typecheck + build)

### Key decisions made
- Followed "display-only" pattern for v1 panels (disabled sliders)
- Added color-coded primary indicators (Red, Green, Blue) for visual clarity
- Included all 7 calibration parameters in XMP export: `ShadowTint`, `RedHue`/`RedSaturation`, `GreenHue`/`GreenSaturation`, `BlueHue`/`BlueSaturation`
- Derived tags from project reference files and GitHub reference searches

### Files changed
- `lib/preset-generator.ts`
- `lib/preset-export.ts`
- `components/Calibration.tsx` (created)
- `app/page.tsx`
- `components/PresetPreview.tsx`
- `lib/preset-generator.test.ts`
- `lib/preset-export.test.ts`
- `plans/progress.txt`

### Notes for next iteration
- Implement selectable color profile export (Issue #14)
- Add deterministic mapping from image stats to calibration adjustments (currently initialized to 0)
